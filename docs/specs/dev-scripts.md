---
id: GHK829
type: spec
---

# Development Scripts

This is a specification for development scripts that are specific to this project. They assume a development workflow based on Git worktrees, where:

- The project is set up with a `base/` folder that hosts the main branch
- Each worktree branch currently being worked on exists on a sibling branch. These get cleaned up as each feature is finished.

For example:

```
project-meta-folder/
├── base/                   # main branch
├── some-feat/              # zamm/some-feat branch worktree
└── another-feat/           # zamm/another-feat branch worktree
```

The development scripts should be stored in the `dev/` folder of the Git root. That is, `base/dev/` will contain the most up-to-date canonical version of these scripts, and `base/some-feat/dev` may contain the same or updated versions of these scripts specifically for that feature.

> [!NOTE]
> The regular agents working _inside_ of one of these base or worktree directories should not care at all about the project's meta structure. For all they care, their copy of the codebase should be the only one that exists.

## Start Worktree Script

The `dev/start-worktree.sh` script provides a standardized way to start work in a new Git worktree. It assumes that we are currently located in the base branch, and performs the following steps:

1. Take in a single input string containing a description of the feature to be worked on
2. Pass the single input string to an LLM (via a tool such as `aichat`) for a new branch name suggestion
3. Create a new [Git worktree](https://git-scm.com/docs/git-worktree) with this name in a sibling directory:

   ```bash
   git worktree add ../<new-worktree-dir> -b zamm/<new-branch-name>
   ```

   Prepend `zamm/` to the new branch name so that it's easy to tell which branches are currently managed by the ZAMM feature cycle.

   Convert any slashes to hyphens when generating the sibling directory path. We don't want arbitrarily deep worktree directories. Make sure that the sibling directory path is not prefixed with `zamm-`: if the LLM suggests `some-feat-name` as a branch name, the Git branch should be `zamm/some-feat-branch` but the sibling directory should be `../some-feat-name/`

4. Create a new Spec file in `docs/spec-history/<sibling-directory-path>.md` with the same name as the sibling directory path, except with a Markdown file extension. Use the `zamm spec changelog <sibling-directory-path> --description "<original-input-string>"` command to do this, as that command will also:
   - Add proper frontmatter
   - Auto-generate an appropriate H1 Markdown title
5. Run implementation-specific setup commands. These commands should be generated by `zamm init scripts` from the target implementation's documentation, and may include tasks such as installing dependencies or bootstrapping tooling. If no additional steps are required, the script should contain a comment noting that no implementation-specific setup is needed so the section never sits empty.
6. Echo a line of the form `ZAMM_INIT_DIR_OVERRIDE=<worktree-path>` so that downstream tooling knows to initialize the `.zamm/` workflow directory in the worktree instead of the base directory.
7. Show the user a message telling them to run the command

   ```bash
   cd ../<new-worktree-dir> && claude "/change-spec"
   ```

> [!NOTE]
> Automatically trusting the new worktree directory in Claude Code is currently not possible from a bash script. The ideal workflow would be to run `claude` from the parent directory (which contains both the base repo and all sibling worktrees) and have Claude prompt the user to trust that parent directory. However, this requires manual user interaction and cannot be automated at this time.

> [!IMPORTANT]
> The script should validate that it **_is_** being run from the main/master branch and should exit with an error if this is not the case. This prevents accidental execution from the wrong directory.

## End Worktree Script

The `dev/end-worktree.sh` script provides a standardized way to wrap up work in an existing Git worktree. It assumes that we are currently located in a feature worktree branch, and performs the following steps:

1. `cd` to the `../base` directory where the main project branch is located
2. `claude 'Merge the <feat-branch> branch into main'. Do not use a fast-forward merge.`

   For example, if we were previously in the `some-feat/` folder, then we would now run

   ```bash
   claude 'Merge the zamm/some-feat branch into main. Do not use a fast-forward merge.'
   ```

   Using Claude allows for an interactive merge in case of merge conflicts.

   > [!IMPORTANT]
   > The script must check if the Claude merge command succeeded. If Claude exits without completing the merge (e.g., the user exits Claude prematurely), the script should exit immediately with an error and not proceed with the remaining steps.
   >
   > One way to verify merge success is to check if the feature branch is now an ancestor of the current HEAD using `git merge-base --is-ancestor <feature-branch> HEAD`. This will return true if the merge completed successfully.

3. Run the build command for our current implementation to ensure that the main folder always has the latest binaries.

   For example, if our current implementation is using NodeJS with `npm` as the package manager, we would run

   ```bash
   npm run build
   ```

4. `git push` to the remote.

5. `git worktree remove <dir>`

   To continue the previous example, we would now run

   ```bash
   git worktree remove ../some-feat
   ```

   to clean up the meta project directory structure.

6. `git branch -d <feat-branch>`

   To continue the previous example, we would now run

   ```bash
   git branch -d zamm/some-feat
   ```

   to clean up local git branches.

> [!IMPORTANT]
> The script should validate that it is **_not_** being run from the main/master branch and should exit with an error if attempted. This prevents accidental execution from the wrong directory.

## Refresh Init Script Templates

A development maintenance script should exist to synchronize the `zamm init scripts` template files (as described in [Spec DVB657](/docs/specs/cli/init/README.md)) with the current working versions in `.claude/` and `dev/`. This ensures that when `zamm init scripts` is run on new projects, they receive the latest workflow scripts and Claude command files.

> [!NOTE]
> Template shell scripts in the resources directory should not be executable. The refresh script must remove the executable bit (set permissions to `0o644` or `rw-r--r--`) from copied shell script files, since these are templates that will be copied and made executable when installed via `zamm init scripts`, not actual executable scripts.

### Behavior

The script should:

1. Validate that it's being run from the Git repository root
2. Copy all files from `.claude/` to the template resources directory, preserving directory structure
3. Copy all files from `dev/` to the template resources directory, preserving directory structure
4. Replace implementation-specific commands in the copied `dev/start-worktree.sh` script with the `{{WORKTREE_SETUP_COMMANDS}}` placeholder
5. Replace implementation-specific commands in the copied `dev/end-worktree.sh` script with the `{{WORKTREE_BUILD_COMMANDS}}` placeholder
6. Print a success message confirming which files were refreshed

### Placeholder Restoration

The script must identify and replace implementation-specific content with template placeholders:

- In `dev/start-worktree.sh`: Replace the content under the `##### Setup worktree environment` section (after the heading) with a single line containing `{{WORKTREE_SETUP_COMMANDS}}`
- In `dev/end-worktree.sh`: Replace the content under Step 3 (between the echo statement and Step 4) with a single line containing `{{WORKTREE_BUILD_COMMANDS}}`

The script should preserve all other content, including comments, error handling, and validation logic.
